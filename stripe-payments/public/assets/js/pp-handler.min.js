function updateAllAmounts(){if(calcTotal(),submitBtn.innerHTML=vars.payBtnText.replace(/%s/g,formatMoney(vars.data.amount)),1===vars.data.show_your_order){if(jQuery("#order-total").html(formatMoney(vars.data.amount)),jQuery("#order-item-price").html(formatMoney(vars.data.item_price*vars.data.quantity)),jQuery("#order-quantity").html(vars.data.quantity),jQuery("#order-tax").html(formatMoney(vars.data.taxAmount*vars.data.quantity)),vars.data.coupon){if(0===jQuery("tr#order-coupon-line").length){var t='<tr id="order-coupon-line"><td>Coupon "'+vars.data.coupon.code+'"</td><td>- <span id="order-coupon"></span></td></tr>';0!==jQuery("tr.variation-line").last().length?jQuery("tr.variation-line").last().after(t):jQuery("tr#order-item-line").after(t)}jQuery("#order-coupon").html(formatMoney(vars.data.coupon.discount_amount*vars.data.quantity))}if(vars.data.variations.applied)for(grpId=0;grpId<vars.data.variations.applied.length;++grpId)0===jQuery("#order-variation-"+grpId+"-line").length&&jQuery("tr#order-item-line").after('<tr id="order-variation-'+grpId+'-line" class="variation-line"><td class="variation-name"></td><td class="variation-price"></td></tr>'),jQuery("#order-variation-"+grpId+"-line").find(".variation-name").html(vars.data.variations.groups[grpId]+"<br>"+vars.data.variations.names[grpId][vars.data.variations.applied[grpId]]),jQuery("#order-variation-"+grpId+"-line").find(".variation-price").html(formatMoney(amount_to_cents(vars.data.variations.prices[grpId][vars.data.variations.applied[grpId]],vars.data.currency)*vars.data.quantity))}doAddonAction("allAmountsUpdated")}function calcTotal(){var t,e=vars.data.item_price,a=0;if(vars.data.variations.applied)for(t=0;t<vars.data.variations.applied.length;++t)e+=amount_to_cents(vars.data.variations.prices[t][vars.data.variations.applied[t]],vars.data.currency);if(vars.data.coupon){var r=0;r="perc"===vars.data.coupon.discount_type?Math.round(e*(vars.data.coupon.discount/100)):is_zero_cents(vars.data.currency)?vars.data.coupon.discount:100*vars.data.coupon.discount,e-=r,vars.data.coupon.discount_amount=r}if(vars.data.tax){var n=Math.round(e*parseFloat(vars.data.tax)/100);vars.data.taxAmount=n,e=parseInt(e)+parseInt(n)}a=e*vars.data.quantity,vars.data.shipping&&(a+=parseInt(vars.data.shipping)),vars.data.amount=a}function is_zero_cents(t){return-1!==vars.zeroCents.indexOf(t)}function cents_to_amount(t,e){return is_zero_cents(e)||(t/=100),t}function amount_to_cents(t,e){return is_zero_cents(e)||(t*=100),t}function showFormInputErr(t,e,a){e.innerHTML=t,jQuery(e).show().hide().fadeIn(),jQuery(a).focus()}function showPopup(){jQuery("#Aligner-item").addClass("popup-show").hide().fadeIn()}function smokeScreen(t){display=t?"flex":"none",document.getElementById("smoke-screen").style.display=display}function formatMoney(t){var e=!1;t<0&&(t=0-t,e=!0),t=cents_to_amount(t,vars.data.currency);var a=isNaN(a=Math.abs(vars.currencyFormat.c))?2:vars.currencyFormat.c,r=void 0==r?".":vars.currencyFormat.d,n=void 0==n?",":vars.currencyFormat.t,o=t<0?"-":"",s=String(parseInt(t=Math.abs(Number(t)||0).toFixed(a))),d=(d=s.length)>3?d%3:0,i=o+(d?s.substr(0,d)+n:"")+s.substr(d).replace(/(\d{3})(?=\d)/g,"$1"+n)+(a?r+Math.abs(t-s).toFixed(a).slice(2):"");return i="right"!==vars.currencyFormat.pos?vars.currencyFormat.s+i:i+vars.currencyFormat.s,e?"- "+i:i}function inIframe(){try{return window.self!==window.top}catch(t){return!0}}function triggerEvent(t,e){var a;"createEvent"in document?(a=document.createEvent("HTMLEvents"),a.initEvent(e,!1,!0),t.dispatchEvent(a)):(a=document.createEventObject(),a.eventType=e,t.fireEvent("on"+a.eventType,a))}function validate_custom_quantity(){var t,e;vars.data.custom_quantity?(e=quantityErr,t=quantityInput.value):(e=errorCont,t=vars.data.quantity);var a=parseInt(t);return isNaN(a)?(showFormInputErr(vars.str.strEnterQuantity,e,quantityInput),!1):t%1!=0?(showFormInputErr(vars.str.strQuantityIsFloat,e,quantityInput),!1):a<=0?(showFormInputErr(vars.str.strQuantityIsZero,e,quantityInput),!1):!0===vars.data.stock_control_enabled&&a>vars.data.stock_items?(showFormInputErr(vars.str.strStockNotAvailable.replace("%d",vars.data.stock_items),e,quantityInput),!1):(e.style.display="none",vars.data.quantity=a,a)}function validate_custom_amount(){var t=amountInput.value;if(0!=vars.amountOpts.applySepOpts?(t=t.replace(vars.amountOpts.thousandSep,""),t=t.replace(vars.amountOpts.decimalSep,".")):(t=t.replace(/\$/g,""),t=t.replace(/,/g,""),t=t.replace(/ /g,"")),t=parseFloat(t),isNaN(t))return showFormInputErr(vars.str.strEnterValidAmount,amountErr,amountInput),!1;var e=t.toFixed(2).toString();if(0!=vars.amountOpts.applySepOpts&&(e=e.replace(".",vars.amountOpts.decimalSep)),is_zero_cents(vars.data.currency)||(t=Math.round(100*t)),void 0!==vars.minAmounts[vars.data.currency]){if(vars.minAmounts[vars.data.currency]>t)return showFormInputErr(vars.str.strMinAmount+" "+cents_to_amount(vars.minAmounts[vars.data.currency],vars.data.currency),amountErr,amountInput),!1}else if(50>t)return showFormInputErr(vars.str.strMinAmount+" 0.5",amountErr,amountInput),!1;return amountErr.style.display="none",amountInput.value=e,t}function canProceed(){if(vars.data.amount_variable){if(!1===(amount=validate_custom_amount()))return event.preventDefault(),!1;vars.data.item_price=amount}if(vars.data.custom_quantity){if(quantity=validate_custom_quantity(),!1===quantity)return event.preventDefault(),!1;vars.data.quantity=quantity}if(""!==piInput.value){if(!inIframe()||window.doSelfSubmit){console.log("Self-submitting");for(var t=0;t<form.elements.length;t++)form.elements[t].name&&form.elements[t].setAttribute("name","asp_"+form.elements[t].name);form.submit()}return!1}if(vars.data.amount_variable){if(!1===(amount=validate_custom_amount()))return!1;vars.data.item_price=amount}var e=!1;return jQuery("#payment-form").find("[required]:visible").each(function(t,a){if(""===jQuery(a).val()||"checkbox"===jQuery(a).attr("type")&&!jQuery(a).prop("checked"))return jQuery(a).focus(),jQuery(a).one("keyup change",function(){jQuery(this).siblings(".auto-required-err-msg").remove(),jQuery(this).parent().siblings(".auto-required-err-msg").remove()}),e=!0,jQuery("#payment-form").find(".auto-required-err-msg").remove(),"checkbox"===jQuery(a).attr("type")?jQuery(a).parent().after(jQuery('<span class="form-err auto-required-err-msg" role="alert">'+vars.str.strPleaseCheckCheckbox+"</span>").fadeIn()):jQuery(a).after(jQuery('<span class="form-err auto-required-err-msg" role="alert">'+vars.str.strPleaseFillIn+"</span>").fadeIn()),!1}),!e&&(vars.data.tos&&!tosInput.checked?(showFormInputErr(vars.str.strMustAcceptTos,tosInputErr,tosInput),!1):(vars.data.canProceed=!0,doAddonAction("submitCanProceed"),!!vars.data.canProceed))}function handlePayment(){var t=document.getElementById("billing-name"),e=document.getElementById("email"),a={name:t.value,email:e.value};if(vars.data.billing_address){var r=document.getElementById("address"),n=document.getElementById("city"),o=document.getElementById("country"),s=document.getElementById("postcode");a.address={line1:r.value,city:n.value,country:o.value||o.options[o.selectedIndex].value};var d=s.value;d&&(a.address.postal_code=d)}if(vars.data.shipping_address){var i={name:t.value},u=document.getElementById("shipping_address"),c=document.getElementById("shipping_city"),l=document.getElementById("shipping_country"),p=document.getElementById("shipping_postcode");i.address={line1:u.value,city:c.value,country:l.value||l.options[l.selectedIndex].value};var m=p.value;m&&(i.address.postal_code=m)}vars.data.billing_address&&vars.data.shipping_address&&billshipSwitch.checked&&(i=JSON.parse(JSON.stringify(a)),delete i.email);var v={payment_method_data:{billing_details:a}};if(i&&(v.shipping=i),!vars.data.create_token&&(""===vars.data.client_secret||vars.data.amount!=clientSecAmount||vars.data.currency!==clientSecCurrency)){console.log("Regen CS");var y="action=asp_pp_req_token&amount="+vars.data.amount+"&curr="+vars.data.currency+"&product_id="+vars.data.product_id;return y=y+"&quantity="+vars.data.quantity,vars.data.cust_id&&(y=y+"&cust_id="+vars.data.cust_id),""!==vars.data.client_secret&&(y=y+"&pi="+vars.data.pi_id),y=y+"&billing_details="+JSON.stringify(a),new ajaxRequest(vars.ajaxURL,y,function(t){try{var e=JSON.parse(t.responseText);return console.log(e),(void 0!==e.stock_items&&vars.data.stock_items!==e.stock_items&&(vars.data.stock_items=e.stock_items,validate_custom_quantity()),e.success)?(vars.data.client_secret=e.clientSecret,vars.data.pi_id=e.pi_id,vars.data.cust_id=e.cust_id,clientSecAmount=vars.data.amount,clientSecCurrency=vars.data.currency,doAddonAction("csRegenCompleted"),!vars.data.doNotProceed&&(handlePayment(),!0)):(submitBtn.disabled=!1,errorCont.innerHTML=e.err,errorCont.style.display="block",smokeScreen(!1),!1)}catch(t){console.log(t),alert("Caught Exception: "+t.description)}},function(t,e){submitBtn.disabled=!1,errorCont.innerHTML=e,errorCont.style.display="block",smokeScreen(!1)}),!1}return doAddonAction("csReady"),!vars.data.doNotProceed&&(vars.data.create_token?(console.log("Creating token"),v={name:t.value},vars.data.billing_address&&(v.address_line1=r.value,v.address_city=n.value,v.address_country=o.value||o.options[o.selectedIndex].value,d&&(v.address_zip=d)),stripe.createToken(card).then(function(t){if(console.log(t),t.error)submitBtn.disabled=!1,errorCont.innerHTML=t.error.message,errorCont.style.display="block",smokeScreen(!1);else{var e="action=asp_pp_confirm_token&asp_token_id="+t.token.id+"&product_id="+vars.data.product_id;vars.data.currency_variable&&(e=e+"&currency="+data.currency),vars.data.amount_variable&&(e=e+"&amount="+vars.data.item_price),e=e+"&billing_details="+JSON.stringify(a),i&&(e=e+"&shipping_details="+JSON.stringify(i)),console.log("Doing action asp_pp_confirm_token"),new ajaxRequest(vars.ajaxURL,e,function(t){try{var e=JSON.parse(t.responseText);if(console.log(e),!e.success)return submitBtn.disabled=!1,errorCont.innerHTML=e.err,errorCont.style.display="block",smokeScreen(!1),!1;document.getElementById("sub_id").value=e.sub_id,e.pi_cs?(vars.data.client_secret=e.pi_cs,vars.data.create_token=!1,e.do_card_setup&&(vars.data.do_card_setup=!0),handlePayment()):(piInput.value=e.pi_id,e.no_action_required&&(vars.data.no_action_required=!0),!vars.data.coupon&&couponInput&&(couponInput.value=""),form.dispatchEvent(new Event("submit")))}catch(t){console.log(t),alert("Caught Exception: "+t.description)}},function(t,e){submitBtn.disabled=!1,errorCont.innerHTML=e,errorCont.style.display="block",smokeScreen(!1)})}}),!1):!!vars.data.no_action_required||void(vars.data.do_card_setup?(console.log("Doing handleCardSetup()"),stripe.handleCardSetup(vars.data.client_secret,card,v).then(function(t){console.log(t),t.error?(submitBtn.disabled=!1,errorCont.innerHTML=t.error.message,errorCont.style.display="block",smokeScreen(!1)):(piInput.value=document.getElementById("sub_id").value,!vars.data.coupon&&couponInput&&(couponInput.value=""),form.dispatchEvent(new Event("submit")))})):(!1!==vars.data.dont_save_card&&(v.save_payment_method=!0,v.setup_future_usage="off_session"),console.log("Doing handleCardPayment()"),stripe.handleCardPayment(vars.data.client_secret,card,v).then(function(t){console.log(t),handleCardPaymentResult(t)}))))}function handleCardPaymentResult(t){t.error?(submitBtn.disabled=!1,errorCont.innerHTML=t.error.message,errorCont.style.display="block",smokeScreen(!1)):(piInput.value=t.paymentIntent.id,!vars.data.coupon&&couponInput&&(couponInput.value=""),form.dispatchEvent(new Event("submit")))}function doAddonAction(t){vars.data.doNotProceed=!1,vars.data.addons&&vars.data.addons.forEach(function(e){void 0===e.obj&&void 0!==window[e.handler]&&(e.obj=new window[e.handler](vars.data)),void 0!==e.obj&&"function"==typeof e.obj[t]&&(console.log(e.name+": "+t),e.obj[t]())})}function toggleRequiredElements(t,e){t.forEach(function(t){e?jQuery("#"+t).hide():jQuery("#"+t).show()}),e?jQuery("#payment-form").find("[required]").not(":visible").each(function(t,e){jQuery(e).prop("required",!1),jQuery(e).attr("data-required-hidden",1)}):jQuery("#payment-form").find('[data-required-hidden="1"]').each(function(t,e){jQuery(e).prop("required",!0),jQuery(e).attr("data-required-hidden",0)})}var errorCont=document.getElementById("global-error");if(vars.fatal_error)throw jQuery("#Aligner-item").show(),new Error(vars.fatal_error);var stripe=Stripe(vars.stripe_key),elements=stripe.elements();if(vars.data.temp=[],vars.data.amount_variable){var amountInput=document.getElementById("amount"),amountErr=document.getElementById("amount-error");amountInput.addEventListener("change",function(){!1!==(amount=validate_custom_amount())&&(vars.data.item_price=amount,updateAllAmounts())})}if(vars.data.custom_quantity){var quantityInput=document.getElementById("quantity"),quantityErr=document.getElementById("quantity-error");quantityInput.addEventListener("change",function(){quantity=validate_custom_quantity(),!1!==quantity&&(vars.data.quantity=quantity,updateAllAmounts())})}if(vars.data.currency_variable){var currencyInput=document.getElementById("currency");currencyInput.addEventListener("change",function(){vars.data.currency=currencyInput.value||currencyInput.options[currencyInput.selectedIndex],vars.currencyFormat.s=currencyInput.options[currencyInput.selectedIndex].getAttribute("data-asp-curr-sym"),updateAllAmounts()})}if(vars.data.coupons_enabled){var couponBtn=document.getElementById("apply-coupon-btn"),couponRemoveBtn=document.getElementById("remove-coupon-btn"),couponResCont=document.getElementById("coupon-res-cont"),couponInputCont=document.getElementById("coupon-input-cont"),couponInput=document.getElementById("coupon-code"),couponErr=document.getElementById("coupon-err"),couponInfo=document.getElementById("coupon-info");couponInput.addEventListener("keydown",function(t){if(13===t.keyCode)return t.preventDefault(),couponBtn.click(),!1}),couponBtn.addEventListener("click",function(t){if(t.preventDefault(),couponErr.style.display="none",""===couponInput.value)return!1;couponBtn.disabled=!0,smokeScreen(!0);var e="action=asp_pp_check_coupon&product_id="+vars.data.product_id+"&coupon_code="+couponInput.value;new ajaxRequest(vars.ajaxURL,e,function(t){console.log(t);var e=JSON.parse(t.responseText);e.err?(delete vars.data.coupon,console.log(e.err),showFormInputErr(e.err,couponErr,couponInput)):(vars.data.coupon=e,console.log(vars.data.coupon),calcTotal(),couponInfo.innerHTML=vars.data.coupon.code+":  - ","perc"===vars.data.coupon.discount_type?couponInfo.innerHTML=couponInfo.innerHTML+vars.data.coupon.discount+"%":couponInfo.innerHTML=couponInfo.innerHTML+formatMoney(vars.data.coupon.discount_amount),couponResCont.style.display="block",couponInputCont.style.display="none"),updateAllAmounts(),couponBtn.disabled=!1,smokeScreen(!1)},function(t,e){errorCont.innerHTML=e,errorCont.style.display="block",couponBtn.disabled=!1,smokeScreen(!1)})}),couponRemoveBtn.addEventListener("click",function(){delete vars.data.coupon,jQuery("#order-coupon-line").remove(),couponInput.value="",couponResCont.style.display="none",couponInputCont.style.display="block",updateAllAmounts()})}var amount=vars.data.amount,clientSecAmount=0,clientSecCurrency="",style={base:{fontSize:"16px"}},submitBtn=document.getElementById("submit-btn"),piInput=document.getElementById("payment-intent"),cardErrorCont=document.getElementById("card-errors"),form=document.getElementById("payment-form");if(vars.data.tos){var tosInput=document.getElementById("tos"),tosInputErr=document.getElementById("tos-error");tosInput.addEventListener("change",function(){tosInputErr.style.display="none"})}if(!jQuery.isEmptyObject(vars.data.variations)){var varInputs=document.getElementsByClassName("variations-input");vars.data.temp.prePopupDisplayVariationsUpdate=!0;for(var i=0;i<varInputs.length;i++)!function(t){varInputs[t].addEventListener("change",function(){var t=this.getAttribute("data-asp-variations-group-id"),e=this.value;0!==Object.getOwnPropertyNames(vars.data.variations).length&&(vars.data.variations.applied||(vars.data.variations.applied=[]),vars.data.variations.applied[t]=e,vars.data.temp.prePopupDisplayVariationsUpdate||updateAllAmounts())}),(varInputs[t].checked||"SELECT"===varInputs[t].tagName)&&triggerEvent(varInputs[t],"change")}(i);vars.data.temp.prePopupDisplayVariationsUpdate=!1,updateAllAmounts()}if(vars.data.billing_address&&vars.data.shipping_address){for(var billshipSwitch=document.getElementById("same-bill-ship-addr"),billaddrCont=document.getElementById("billing-addr-cont"),shipaddrCont=document.getElementById("shipping-addr-cont"),baddrToggles=document.getElementsByClassName("baddr-toggle"),baddrHide=document.getElementsByClassName("baddr-hide"),saddrRequired=document.getElementsByClassName("saddr-required"),itemsArr=[],i=0;i<baddrToggles.length;i++)!function(t){itemsArr.push(baddrToggles[t])}(i);billshipSwitch.addEventListener("change",function(){var t;if(billshipSwitch.checked){for(t=0;t<itemsArr.length;t++)!function(t){attr=itemsArr[t].getAttribute("data-class-save"),itemsArr[t].className=attr}(t);for(t=0;t<baddrHide.length;t++)!function(t){baddrHide[t].style.display="inline-block"}(t);for(t=0;t<saddrRequired.length;t++)!function(t){saddrRequired[t].required=!1}(t);billaddrCont.className="",shipaddrCont.style.display="none"}else{for(t=0;t<itemsArr.length;t++)!function(t){itemsArr[t].setAttribute("data-class-save",itemsArr[t].className),itemsArr[t].className="pure-u-1"}(t);for(t=0;t<baddrHide.length;t++)!function(t){baddrHide[t].style.display="none"}(t);for(t=0;t<saddrRequired.length;t++)!function(t){saddrRequired[t].required=!0}(t);billaddrCont.className="half-width",shipaddrCont.style.display="inline-block"}})}var card=elements.create("card",{style:style,hidePostalCode:!0});card.on("ready",function(){submitBtn.disabled=!1}),card.mount("#card-element"),card.addEventListener("change",function(t){errorCont.style.display="none",t.error?cardErrorCont.textContent=t.error.message:cardErrorCont.textContent=""}),submitBtn.addEventListener("click",function(){vars.data.isEvent||(vars.data.buttonClicked="")}),form.addEventListener("submit",function(t){if(t.preventDefault(),!canProceed())return!1;errorCont.style.display="none",submitBtn.disabled=!0,updateAllAmounts(),smokeScreen(!0),doAddonAction("readyToProceed"),handlePayment()}),vars.data.initShowPopup=!0,doAddonAction("init"),vars.data.initShowPopup&&showPopup(),jQuery(".pm-select-btn").click(function(){vars.data.currentPM=jQuery(this).data("pm-id"),jQuery(".pm-select-btn").parent().removeClass("pure-menu-selected"),jQuery(this).parent().addClass("pure-menu-selected"),doAddonAction("pmSelectClicked"),jQuery("#payment-form").find('[data-pm-name][data-pm-name!="'+vars.data.currentPM+'"]').hide(),jQuery("#payment-form").find('[data-pm-name="'+vars.data.currentPM+'"]').show()});var ajaxRequest=function(t,e,a,r){var n=this;if(this.URL=t,this.reqStr=e,this.doneFunc=a,this.failFunc=r,this.XMLHttpReq=new XMLHttpRequest,!this.XMLHttpReq)return alert("Cannot create an XMLHTTP instance"),!1;n.XMLHttpReq.onreadystatechange=function(){if(n.XMLHttpReq.readyState===XMLHttpRequest.DONE)if(200===n.XMLHttpReq.status)n.doneFunc(n.XMLHttpReq);else{console.log("ajaxRequest failed"),console.log(n.XMLHttpReq);var t="Error occurred: "+n.XMLHttpReq.statusText+"\n";t+="URL: "+n.XMLHttpReq.responseURL+"\n",t+="Code: "+n.XMLHttpReq.status,n.failFunc&&n.failFunc(n.XMLHttpReq,t)}},n.XMLHttpReq.open("POST",n.URL),n.XMLHttpReq.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.XMLHttpReq.send(e)};